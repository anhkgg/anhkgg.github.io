<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>libcurl小记-简单http封装使用-源码分析 | Anhkgg&#39;s website | 内核研究 | 逆向分析 | 漏洞分析挖掘 | Windows Kernel | Rootkit | Reverse Engineer | Expolit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="0x00. 前面以前用Wininet api包了一个简单易用的http请求的lib，但是居然会遇到系统不支持的情况，难道要我自己用socket写吗？no way！ 以前知道liburl，第一次使用，啥都不知道，反正感觉挺强大的 &amp;lt; libcurl is a free and easy-to-use client-side URL transfer library, supporting DI">
<meta name="keywords" content="libcurl,http,minihttp,get_post_ajax">
<meta property="og:type" content="article">
<meta property="og:title" content="libcurl小记-简单http封装使用-源码分析">
<meta property="og:url" content="https://anhkgg.github.io/liburl-use-minihttp/index.html">
<meta property="og:site_name" content="Anhkgg&#39;s website | 内核研究 | 逆向分析 | 漏洞分析挖掘 | Windows Kernel | Rootkit | Reverse Engineer | Expolit">
<meta property="og:description" content="0x00. 前面以前用Wininet api包了一个简单易用的http请求的lib，但是居然会遇到系统不支持的情况，难道要我自己用socket写吗？no way！ 以前知道liburl，第一次使用，啥都不知道，反正感觉挺强大的 &amp;lt; libcurl is a free and easy-to-use client-side URL transfer library, supporting DI">
<meta property="og:updated_time" content="2016-08-26T00:29:49.952Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="libcurl小记-简单http封装使用-源码分析">
<meta name="twitter:description" content="0x00. 前面以前用Wininet api包了一个简单易用的http请求的lib，但是居然会遇到系统不支持的情况，难道要我自己用socket写吗？no way！ 以前知道liburl，第一次使用，啥都不知道，反正感觉挺强大的 &amp;lt; libcurl is a free and easy-to-use client-side URL transfer library, supporting DI">
  
    <link rel="alternative" href="/atom.xml" title="Anhkgg&#39;s website | 内核研究 | 逆向分析 | 漏洞分析挖掘 | Windows Kernel | Rootkit | Reverse Engineer | Expolit" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://avatars0.githubusercontent.com/u/9443285?v=3&amp;s=460" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Anhkgg</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Windows Kernel/Rootkit/Reverse Engineer/Expolit/内核研究/逆向分析/漏洞分析挖掘</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						<li>Links</li>
						
						
						<li>Über</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/anhkgg" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/u/5829043072" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
								<a class="mail" target="_blank" href="mailto:anhkgg@163.com" title="mail">mail</a>
					        
						</div>
						
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/010editor/" style="font-size: 10px;">010editor</a> <a href="/tags/APC/" style="font-size: 10px;">APC</a> <a href="/tags/GS/" style="font-size: 10px;">GS</a> <a href="/tags/HOOK/" style="font-size: 10px;">HOOK</a> <a href="/tags/IDAPro/" style="font-size: 10px;">IDAPro</a> <a href="/tags/IDAPython/" style="font-size: 10px;">IDAPython</a> <a href="/tags/IDC/" style="font-size: 10px;">IDC</a> <a href="/tags/PE/" style="font-size: 10px;">PE</a> <a href="/tags/RPC/" style="font-size: 10px;">RPC</a> <a href="/tags/WM-KEYBOARD-LL/" style="font-size: 10px;">WM_KEYBOARD_LL</a> <a href="/tags/Windbg调试/" style="font-size: 10px;">Windbg调试</a> <a href="/tags/asm/" style="font-size: 10px;">asm</a> <a href="/tags/c/" style="font-size: 10px;">c++</a> <a href="/tags/cookie/" style="font-size: 10px;">cookie</a> <a href="/tags/ctf/" style="font-size: 15px;">ctf</a> <a href="/tags/freepiano/" style="font-size: 10px;">freepiano</a> <a href="/tags/function-analysis/" style="font-size: 10px;">function analysis</a> <a href="/tags/get-post-ajax/" style="font-size: 10px;">get_post_ajax</a> <a href="/tags/handle/" style="font-size: 10px;">handle</a> <a href="/tags/hctf/" style="font-size: 10px;">hctf</a> <a href="/tags/hook/" style="font-size: 10px;">hook</a> <a href="/tags/http/" style="font-size: 10px;">http</a> <a href="/tags/inject/" style="font-size: 10px;">inject</a> <a href="/tags/inject-process/" style="font-size: 15px;">inject process</a> <a href="/tags/insertcall/" style="font-size: 10px;">insertcall</a> <a href="/tags/instrument/" style="font-size: 10px;">instrument</a> <a href="/tags/libcurl/" style="font-size: 10px;">libcurl</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/minihttp/" style="font-size: 10px;">minihttp</a> <a href="/tags/patch/" style="font-size: 10px;">patch</a> <a href="/tags/pin/" style="font-size: 10px;">pin</a> <a href="/tags/pintool/" style="font-size: 10px;">pintool</a> <a href="/tags/pyspider/" style="font-size: 10px;">pyspider</a> <a href="/tags/reverse/" style="font-size: 20px;">reverse</a> <a href="/tags/rust/" style="font-size: 10px;">rust</a> <a href="/tags/sctf/" style="font-size: 10px;">sctf</a> <a href="/tags/shellcode/" style="font-size: 10px;">shellcode</a> <a href="/tags/ssctf/" style="font-size: 15px;">ssctf</a> <a href="/tags/unpack/" style="font-size: 10px;">unpack</a> <a href="/tags/upx/" style="font-size: 10px;">upx</a> <a href="/tags/wechat/" style="font-size: 10px;">wechat</a> <a href="/tags/windows/" style="font-size: 10px;">windows</a> <a href="/tags/writeup/" style="font-size: 10px;">writeup</a> <a href="/tags/指令级/" style="font-size: 10px;">指令级</a> <a href="/tags/插桩/" style="font-size: 10px;">插桩</a> <a href="/tags/远程过程调用/" style="font-size: 10px;">远程过程调用</a> <a href="/tags/钩子/" style="font-size: 10px;">钩子</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://navisec.it/">NaviSec.it – 纳威安全导航</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">Windows Kernel/Rootkit/Reverse Engineer/Expolit/内核研究/逆向分析/漏洞分析挖掘</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Anhkgg</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="https://avatars0.githubusercontent.com/u/9443285?v=3&amp;s=460" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">Anhkgg</h1>
			</hgroup>
			
			<p class="header-subtitle">Windows Kernel/Rootkit/Reverse Engineer/Expolit/内核研究/逆向分析/漏洞分析挖掘</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/anhkgg" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/u/5829043072" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
						<a class="mail" target="_blank" href="mailto:anhkgg@163.com" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-liburl-use-minihttp" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/liburl-use-minihttp/" class="article-date">
  	<time datetime="2016-08-25T12:32:06.000Z" itemprop="datePublished">2016-08-25</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      libcurl小记-简单http封装使用-源码分析
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/get-post-ajax/">get_post_ajax</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/http/">http</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/libcurl/">libcurl</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/minihttp/">minihttp</a></li></ul>
	</div>

        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/code/">code</a>
	</div>


        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="0x00-前面"><a href="#0x00-前面" class="headerlink" title="0x00. 前面"></a>0x00. 前面</h1><p>以前用Wininet api包了一个简单易用的http请求的lib，但是居然会遇到系统不支持的情况，难道要我自己用socket写吗？no way！</p>
<p>以前知道liburl，第一次使用，啥都不知道，反正感觉挺强大的</p>
<p>&lt; libcurl is a free and easy-to-use client-side URL transfer library, supporting DICT, FILE, FTP, FTPS, Gopher, HTTP, HTTPS, IMAP, IMAPS, LDAP, LDAPS, POP3, POP3S, RTMP, RTSP, SCP, SFTP, SMTP, SMTPS, Telnet and TFTP.</p>
<p>须知，我这里只用到了HTTP</p>
<p><a href="https://curl.haxx.se/" target="_blank" rel="external">home: https://curl.haxx.se/</a></p>
<p><a href="https://curl.haxx.se/libcurl/" target="_blank" rel="external">document: https://curl.haxx.se/libcurl/</a></p>
<p>其实使用比较简单，但对我没有认真看过文档，并且没有找到好资料的情况下，我遇到了很多弯路，并且想吐槽实例代码，搞那么复杂干嘛，还没有我想要的代码。</p>
<a id="more"></a>
<p>下面开始坑。</p>
<h1 id="0x01-就这么简单"><a href="#0x01-就这么简单" class="headerlink" title="0x01. 就这么简单"></a>0x01. 就这么简单</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">/* curl stuff */ </div><div class="line">#include &lt;curl/curl.h&gt;</div><div class="line">//#pragma comment(lib, &quot;liburl.lib&quot;)</div><div class="line"></div><div class="line">int main(void)</div><div class="line">&#123;</div><div class="line">  CURL *curl;</div><div class="line">  CURLcode res;</div><div class="line"> </div><div class="line">  /* In windows, this will init the winsock stuff */ </div><div class="line">  curl_global_init(CURL_GLOBAL_ALL);</div><div class="line"> </div><div class="line">  /* get a curl handle */ </div><div class="line">  curl = curl_easy_init();</div><div class="line">  if(curl) &#123;</div><div class="line">    /* First set the URL that is about to receive our POST. This URL can</div><div class="line">       just as well be a https:// URL if that is what should receive the</div><div class="line">       data. */ </div><div class="line">    curl_easy_setopt(curl, CURLOPT_URL, &quot;http://postit.example.com/moo.cgi&quot;);</div><div class="line">    /* Now specify the POST data */ </div><div class="line">    curl_easy_setopt(curl, CURLOPT_POSTFIELDS, &quot;name=daniel&amp;project=curl&quot;);</div><div class="line"> </div><div class="line">    /* Perform the request, res will get the return code */ </div><div class="line">    res = curl_easy_perform(curl);</div><div class="line">    /* Check for errors */ </div><div class="line">    if(res != CURLE_OK)</div><div class="line">      fprintf(stderr, &quot;curl_easy_perform() failed: %s\n&quot;,</div><div class="line">              curl_easy_strerror(res));</div><div class="line"> </div><div class="line">    /* always cleanup */ </div><div class="line">    curl_easy_cleanup(curl);</div><div class="line">  &#125;</div><div class="line">  curl_global_cleanup();</div><div class="line">  return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>简单应用就是这样子，关键在这两句<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">curl_easy_setopt(curl, CURLOPT_URL, &quot;http://postit.example.com/moo.cgi&quot;);</div><div class="line">    /* Now specify the POST data */ </div><div class="line">curl_easy_setopt(curl, CURLOPT_POSTFIELDS, &quot;name=daniel&amp;project=curl&quot;);</div></pre></td></tr></table></figure></p>
<p>liburl通过设置各种回调函数来完成各种功能。</p>
<h1 id="0x02-http请求"><a href="#0x02-http请求" class="headerlink" title="0x02. http请求"></a>0x02. http请求</h1><p>CURLOPT_URL ： 访问的目标url路径，如果是GET方式请求，需要将请求数据加到URL后面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">www.baidu.com/login.asp?name=111&amp;password=111</div></pre></td></tr></table></figure>
<p>CURLOPT_POSTFIELDS ： POST请求中发送的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl_easy_setopt(curl, CURLOPT_POSTFIELDS, &quot;name=daniel&amp;project=curl&quot;);</div></pre></td></tr></table></figure>
<p>并且POST请求中还需要设置CURLOPT_POST为1</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/* size of the POST data */</div><div class="line">curl_easy_setopt(curl, CURLOPT_POSTFIELDSIZE, data.length());</div><div class="line">curl_easy_setopt(curl, CURLOPT_POST, 1);</div></pre></td></tr></table></figure>
<p>另外，奇葩的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl_easy_setopt(curl, CURLOPT_URL, url.c_str()); //url在release可正常使用，debug去不行，只能使用url.c_str();</div></pre></td></tr></table></figure></p>
<h1 id="0x03-接收数据"><a href="#0x03-接收数据" class="headerlink" title="0x03. 接收数据"></a>0x03. 接收数据</h1><p>接收数据需要注册CURLOPT_WRITEFUNCTION回调函数，在回调函数中进行数据处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl_easy_setopt(*curl, CURLOPT_WRITEFUNCTION, write_callback);</div></pre></td></tr></table></figure>
<p>如果数据不能一次接收完成，需要利用回调中的参数来缓存数据，也就是通过CURLOPT_WRITEDATA设置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl_easy_setopt(*curl, CURLOPT_WRITEDATA, data);</div></pre></td></tr></table></figure>
<p>回调函数处理中，最后一次参数就是设置的用于缓存的变量，需要注意的是数据长度，不是size，而是<code>size*nmemb</code>。 并且如果返回值不等于size*nmemb，libcurl会认为处理失败</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">size_t write_callback(char *ptr, size_t size, size_t nmemb, void *userdata)</div><div class="line">&#123;</div><div class="line">	size_t all_size = size*nmemb;</div><div class="line">	PWRITE_CALLBACK_DATA data = (PWRITE_CALLBACK_DATA)userdata;</div><div class="line"></div><div class="line">	data-&gt;data.append(ptr);</div><div class="line">	data-&gt;size += all_size;</div><div class="line"></div><div class="line">	return all_size;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="0x04-cookie"><a href="#0x04-cookie" class="headerlink" title="0x04. cookie"></a>0x04. cookie</h1><p>通过cookie文件保存，读取cookie</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">curl_easy_setopt(*curl, CURLOPT_COOKIEJAR, &quot;cookie.txt&quot;);        //把服务器发过来的cookie保存到cookie.txt</div><div class="line">curl_easy_setopt(*curl, CURLOPT_COOKIEFILE, &quot;cookie.txt&quot;);        //读取本地存储的cookie</div></pre></td></tr></table></figure>
<p>直接设置cookie信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">//curl_easy_setopt(curl, CURLOPT_COOKIE, m_cookies.c_str());</div></pre></td></tr></table></figure>
<h1 id="0x05-一点点分析"><a href="#0x05-一点点分析" class="headerlink" title="0x05. 一点点分析"></a>0x05. 一点点分析</h1><p>下面是遇到坑时的一小点点源码翻阅，觉得有用的可以看看</p>
<h2 id="1-curl-easy-setopt调用中"><a href="#1-curl-easy-setopt调用中" class="headerlink" title="1. curl_easy_setopt调用中"></a>1. curl_easy_setopt调用中</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">//curl_easy_setopt调用中</div><div class="line">CURLcode curl_easy_setopt(struct Curl_easy *data, CURLoption tag, ...)//lib/easy.c</div><div class="line">--&gt;</div><div class="line">CURLcode Curl_setopt(struct Curl_easy *data, CURLoption option,</div><div class="line">                     va_list param)//lib/url.c</div><div class="line">&#123;</div><div class="line">    //根据option类型，设置不同回调</div><div class="line">    //保存在data-&gt;set的不同字段中</div><div class="line">    case CURLOPT_URL:</div><div class="line">    if(data-&gt;change.url_alloc) &#123;</div><div class="line">      /* the already set URL is allocated, free it first! */</div><div class="line">      Curl_safefree(data-&gt;change.url);</div><div class="line">      data-&gt;change.url_alloc = FALSE;</div><div class="line">    &#125;</div><div class="line">    result = setstropt(&amp;data-&gt;set.str[STRING_SET_URL],</div><div class="line">                       va_arg(param, char *));</div><div class="line">    data-&gt;change.url = data-&gt;set.str[STRING_SET_URL];</div><div class="line">    break;</div><div class="line">    case CURLOPT_PORT:</div><div class="line">    data-&gt;set.use_port = va_arg(param, long);</div><div class="line">    break;</div><div class="line">    case CURLOPT_WRITEFUNCTION:</div><div class="line">    data-&gt;set.fwrite_func = va_arg(param, curl_write_callback);</div><div class="line">    if(!data-&gt;set.fwrite_func) &#123;</div><div class="line">      data-&gt;set.is_fwrite_set = 0;</div><div class="line">      /* When set to NULL, reset to our internal default function */</div><div class="line">      data-&gt;set.fwrite_func = (curl_write_callback)fwrite;</div><div class="line">    &#125;</div><div class="line">    else</div><div class="line">      data-&gt;set.is_fwrite_set = 1;</div><div class="line">    break;</div><div class="line">    case CURLOPT_WRITEDATA:</div><div class="line">    data-&gt;set.out = va_arg(param, void *);</div><div class="line">    break;</div><div class="line">    case CURLOPT_HTTPHEADER:</div><div class="line">    data-&gt;set.headers = va_arg(param, struct curl_slist *);</div><div class="line">    break;</div><div class="line">    case CURLOPT_COOKIEJAR:</div><div class="line">    &#123;</div><div class="line">    struct CookieInfo *newcookies;</div><div class="line">    result = setstropt(&amp;data-&gt;set.str[STRING_COOKIEJAR],</div><div class="line">                       va_arg(param, char *));</div><div class="line">    newcookies = Curl_cookie_init(data, NULL, data-&gt;cookies,</div><div class="line">                                  data-&gt;set.cookiesession);</div><div class="line">    if(!newcookies)</div><div class="line">      result = CURLE_OUT_OF_MEMORY;</div><div class="line">    data-&gt;cookies = newcookies;</div><div class="line">    &#125;</div><div class="line">    break;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-请求中"><a href="#2-请求中" class="headerlink" title="2. 请求中"></a>2. 请求中</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div></pre></td><td class="code"><pre><div class="line">CURLcode curl_easy_perform(struct Curl_easy *data)//lib/easy.c</div><div class="line">-&gt;</div><div class="line">static CURLcode easy_perform(struct Curl_easy *data, bool events)//lib/easy.c</div><div class="line">-&gt;</div><div class="line">static CURLcode easy_transfer(struct Curl_multi *multi)//lib/easy.c</div><div class="line">-&gt;</div><div class="line">CURLMcode curl_multi_perform(struct Curl_multi *multi, int *running_handles)//\lib\multi.c</div><div class="line">&#123;</div><div class="line">  data=multi-&gt;easyp;//就是Curl_easy *data</div><div class="line">  while(data) &#123;</div><div class="line">    CURLMcode result;</div><div class="line">    SIGPIPE_VARIABLE(pipe_st);</div><div class="line"></div><div class="line">    sigpipe_ignore(data, &amp;pipe_st);</div><div class="line">    result = multi_runsingle(multi, now, data);//一次请求</div><div class="line">    sigpipe_restore(&amp;pipe_st);</div><div class="line"></div><div class="line">    if(result)</div><div class="line">      returncode = result;</div><div class="line"></div><div class="line">    data = data-&gt;next; /* operate on next handle */</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">-&gt;</div><div class="line">static CURLMcode multi_runsingle(struct Curl_multi *multi,</div><div class="line">                                 struct timeval now,</div><div class="line">                                 struct Curl_easy *data)//\lib\multi.c</div><div class="line">&#123;</div><div class="line">    //这里面有个重要的字段data-&gt;mstate，表示当前curl的状态</div><div class="line">    //通过multistate(data, CURLM_STATE_PERFORM);=&gt;static void mstate(struct Curl_easy *data, CURLMstate state)赋值</div><div class="line">    //CURLMcode curl_multi_add_handle(struct Curl_multi *multi, struct Curl_easy *data) =&gt; multistate(data, CURLM_STATE_INIT);</div><div class="line">    //CURLMcode Curl_multi_add_perform(struct Curl_multi *multi, struct Curl_easy *data, struct connectdata *conn)=&gt;multistate(data, CURLM_STATE_PERFORM);</div><div class="line">    //等等</div><div class="line">    </div><div class="line">    //...</div><div class="line">    do&#123;</div><div class="line">        //本函数中，循环各种状态判断，处理不同逻辑</div><div class="line">        switch(data-&gt;mstate) &#123;</div><div class="line">        //初始化</div><div class="line">        case CURLM_STATE_INIT:</div><div class="line">          /* init this transfer. */</div><div class="line">          result=Curl_pretransfer(data);//各种信息初始化，ssl，cookie</div><div class="line">    </div><div class="line">          if(!result) &#123;</div><div class="line">            /* after init, go CONNECT */</div><div class="line">            multistate(data, CURLM_STATE_CONNECT);//状态更改</div><div class="line">            Curl_pgrsTime(data, TIMER_STARTOP);</div><div class="line">            rc = CURLM_CALL_MULTI_PERFORM;</div><div class="line">          &#125;</div><div class="line">          break;</div><div class="line">         case CURLM_STATE_CONNECT:</div><div class="line">          /* Connect. We want to get a connection identifier filled in. */</div><div class="line">          Curl_pgrsTime(data, TIMER_STARTSINGLE);</div><div class="line">          result = Curl_connect(data, &amp;data-&gt;easy_conn,</div><div class="line">                                &amp;async, &amp;protocol_connect);</div><div class="line">          if(CURLE_NO_CONNECTION_AVAILABLE == result) &#123;</div><div class="line">            /* There was no connection available. We will go to the pending</div><div class="line">               state and wait for an available connection. */</div><div class="line">            multistate(data, CURLM_STATE_CONNECT_PEND);</div><div class="line">    </div><div class="line">            /* add this handle to the list of connect-pending handles */</div><div class="line">            if(!Curl_llist_insert_next(multi-&gt;pending, multi-&gt;pending-&gt;tail, data))</div><div class="line">              result = CURLE_OUT_OF_MEMORY;</div><div class="line">            else</div><div class="line">              result = CURLE_OK;</div><div class="line">            break;</div><div class="line">          &#125;</div><div class="line">    </div><div class="line">          if(!result) &#123;</div><div class="line">            /* Add this handle to the send or pend pipeline */</div><div class="line">            result = Curl_add_handle_to_pipeline(data, data-&gt;easy_conn);</div><div class="line">            if(result)</div><div class="line">              disconnect_conn = TRUE;</div><div class="line">            else &#123;</div><div class="line">              if(async)</div><div class="line">                /* We&apos;re now waiting for an asynchronous name lookup */</div><div class="line">                multistate(data, CURLM_STATE_WAITRESOLVE);</div><div class="line">              else &#123;</div><div class="line">                /* after the connect has been sent off, go WAITCONNECT unless the</div><div class="line">                   protocol connect is already done and we can go directly to</div><div class="line">                   WAITDO or DO! */</div><div class="line">                rc = CURLM_CALL_MULTI_PERFORM;</div><div class="line">    </div><div class="line">                if(protocol_connect)</div><div class="line">                  multistate(data, Curl_pipeline_wanted(multi, CURLPIPE_HTTP1)?</div><div class="line">                             CURLM_STATE_WAITDO:CURLM_STATE_DO);</div><div class="line">                else &#123;</div><div class="line">    #ifndef CURL_DISABLE_HTTP</div><div class="line">                  if(data-&gt;easy_conn-&gt;tunnel_state[FIRSTSOCKET] == TUNNEL_CONNECT)</div><div class="line">                    multistate(data, CURLM_STATE_WAITPROXYCONNECT);</div><div class="line">                  else</div><div class="line">    #endif</div><div class="line">                    multistate(data, CURLM_STATE_WAITCONNECT);</div><div class="line">                &#125;</div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">          break;</div><div class="line">        case CURLM_STATE_DO://开始发送</div><div class="line">            /* Perform the protocol&apos;s DO action */</div><div class="line">            result = multi_do(&amp;data-&gt;easy_conn, &amp;dophase_done);</div><div class="line">            //-&gt;</div><div class="line">            //详细的http请求封装，可以看看这个Curl_http</div><div class="line">            //CURLcode Curl_http(struct connectdata *conn, bool *done)//\lib\http.c</div><div class="line">            </div><div class="line">        case CURLM_STATE_DONE:</div><div class="line">            /* post-transfer command */</div><div class="line">            res = multi_done(&amp;data-&gt;easy_conn, result, FALSE);</div><div class="line">            </div><div class="line">        case CURLM_STATE_PERFORM:</div><div class="line">            /* read/write data if it is ready to do so */</div><div class="line">            result = Curl_readwrite(data-&gt;easy_conn, data, &amp;done);//接受数据中</div><div class="line"></div><div class="line">        //...</div><div class="line">        </div><div class="line">    &#125;while((rc == CURLM_CALL_MULTI_PERFORM) || multi_ischanged(multi, FALSE));</div><div class="line"></div><div class="line">  data-&gt;result = result;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//所有状态</div><div class="line">/* NOTE: if you add a state here, add the name to the statename[] array as</div><div class="line">   well!</div><div class="line">*/</div><div class="line">typedef enum &#123;</div><div class="line">  CURLM_STATE_INIT,         /* 0 - start in this state */</div><div class="line">  CURLM_STATE_CONNECT_PEND, /* 1 - no connections, waiting for one */</div><div class="line">  CURLM_STATE_CONNECT,      /* 2 - resolve/connect has been sent off */</div><div class="line">  CURLM_STATE_WAITRESOLVE,  /* 3 - awaiting the resolve to finalize */</div><div class="line">  CURLM_STATE_WAITCONNECT,  /* 4 - awaiting the TCP connect to finalize */</div><div class="line">  CURLM_STATE_WAITPROXYCONNECT, /* 5 - awaiting proxy CONNECT to finalize */</div><div class="line">  CURLM_STATE_SENDPROTOCONNECT, /* 6 - initiate protocol connect procedure */</div><div class="line">  CURLM_STATE_PROTOCONNECT, /* 7 - completing the protocol-specific connect</div><div class="line">                                   phase */</div><div class="line">  CURLM_STATE_WAITDO,       /* 8 - wait for our turn to send the request */</div><div class="line">  CURLM_STATE_DO,           /* 9 - start send off the request (part 1) */</div><div class="line">  CURLM_STATE_DOING,        /* 10 - sending off the request (part 1) */</div><div class="line">  CURLM_STATE_DO_MORE,      /* 11 - send off the request (part 2) */</div><div class="line">  CURLM_STATE_DO_DONE,      /* 12 - done sending off request */</div><div class="line">  CURLM_STATE_WAITPERFORM,  /* 13 - wait for our turn to read the response */</div><div class="line">  CURLM_STATE_PERFORM,      /* 14 - transfer data */</div><div class="line">  CURLM_STATE_TOOFAST,      /* 15 - wait because limit-rate exceeded */</div><div class="line">  CURLM_STATE_DONE,         /* 16 - post data transfer operation */</div><div class="line">  CURLM_STATE_COMPLETED,    /* 17 - operation complete */</div><div class="line">  CURLM_STATE_MSGSENT,      /* 18 - the operation complete message is sent */</div><div class="line">  CURLM_STATE_LAST          /* 19 - not a true state, never use this */</div><div class="line">&#125; CURLMstate;</div><div class="line"></div><div class="line"></div><div class="line">//单独看connect</div><div class="line">CURLcode Curl_connect(struct Curl_easy *data,</div><div class="line">                      struct connectdata **in_connect,</div><div class="line">                      bool *asyncp,</div><div class="line">                      bool *protocol_done)</div><div class="line">&#123;</div><div class="line">    static CURLcode create_conn(struct Curl_easy *data,</div><div class="line">                            struct connectdata **in_connect,</div><div class="line">                            bool *async)</div><div class="line">    -&gt;</div><div class="line">    static CURLcode resolve_server(struct Curl_easy *data,</div><div class="line">                               struct connectdata *conn,</div><div class="line">                               bool *async)</div><div class="line">                               </div><div class="line">&#125;  </div><div class="line"></div><div class="line">result = Curl_async_resolved(data-&gt;easy_conn, &amp;protocol_connect);-&gt;</div><div class="line">result = Curl_setup_conn(conn, protocol_done);-&gt;</div><div class="line">result = Curl_connecthost(conn, conn-&gt;dns_entry);-&gt;</div><div class="line">result = singleipconnect(conn, conn-&gt;tempaddr[0], &amp;(conn-&gt;tempsock[0]));-&gt;</div><div class="line">static CURLcode singleipconnect(struct connectdata *conn,</div><div class="line">                                const Curl_addrinfo *ai,</div><div class="line">                                curl_socket_t *sockp)</div><div class="line">-&gt;</div><div class="line">CURLcode Curl_socket(struct connectdata *conn,</div><div class="line">                     const Curl_addrinfo *ai,</div><div class="line">                     struct Curl_sockaddr_ex *addr,</div><div class="line">                     curl_socket_t *sockfd)</div><div class="line">                     </div><div class="line">//Crul对socket等的封装</div><div class="line">//\lib\connect.c</div><div class="line">CURLcode Curl_socket(struct connectdata *conn,</div><div class="line">                     const Curl_addrinfo *ai,</div><div class="line">                     struct Curl_sockaddr_ex *addr,</div><div class="line">                     curl_socket_t *sockfd)</div><div class="line">CURLcode Curl_connecthost(struct connectdata *conn,  /* context */</div><div class="line">                          const struct Curl_dns_entry *remotehost)           int Curl_closesocket(struct connectdata *conn,</div><div class="line">                      curl_socket_t sock)</div><div class="line">curl_socket_t Curl_getconnectinfo(struct Curl_easy *data,</div><div class="line">                                  struct connectdata **connp)</div></pre></td></tr></table></figure>
<h2 id="3-接受数据时"><a href="#3-接受数据时" class="headerlink" title="3. 接受数据时"></a>3. 接受数据时</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">static CURLMcode multi_runsingle(struct Curl_multi *multi,</div><div class="line">                                 struct timeval now,</div><div class="line">                                 struct Curl_easy *data)//\lib\multi.c</div><div class="line">-&gt;</div><div class="line">CURLcode Curl_readwrite(struct connectdata *conn,</div><div class="line">                        struct Curl_easy *data,</div><div class="line">                        bool *done)//\lib\transfer.c</div><div class="line">&#123;</div><div class="line"> /* We go ahead and do a read if we have a readable socket or if</div><div class="line">     the stream was rewound (in which case we have data in a</div><div class="line">     buffer) */</div><div class="line">  if((k-&gt;keepon &amp; KEEP_RECV) &amp;&amp;</div><div class="line">     ((select_res &amp; CURL_CSELECT_IN) || conn-&gt;bits.stream_was_rewound)) &#123;</div><div class="line"></div><div class="line">    result = readwrite_data(data, conn, k, &amp;didwhat, done);//</div><div class="line">    if(result || *done)</div><div class="line">      return result;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">-&gt;</div><div class="line">static CURLcode readwrite_data(struct Curl_easy *data,</div><div class="line">                               struct connectdata *conn,</div><div class="line">                               struct SingleRequest *k,</div><div class="line">                               int *didwhat, bool *done)//\lib\transfer.c</div><div class="line">&#123;</div><div class="line">    //接受头部</div><div class="line">    result = Curl_http_readwrite_headers(data, conn, &amp;nread, &amp;stop_reading);</div><div class="line">    //-&gt;</div><div class="line">    //CURLcode Curl_client_write(struct connectdata *conn,</div><div class="line">    //                       int type,</div><div class="line">    //                       char *ptr,</div><div class="line">    //                       size_t len)//lib\sendf.c</div><div class="line">    </div><div class="line">    //接受数据</div><div class="line">    result = Curl_client_write(conn, CLIENTWRITE_BODY, k-&gt;str,</div><div class="line">                                           nread);</div><div class="line">    //-》</div><div class="line">    //Curl_client_write-&gt;Curl_client_chop_write-&gt; 调用回调函数</div><div class="line">    //</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line">//调用回调函数</div><div class="line">CURLcode Curl_client_chop_write(struct connectdata *conn,</div><div class="line">                                int type,</div><div class="line">                                char * ptr,</div><div class="line">                                size_t len)</div><div class="line">&#123;               </div><div class="line"></div><div class="line">    curl_write_callback writeheader = NULL;</div><div class="line">    curl_write_callback writebody = NULL;</div><div class="line">    //...</div><div class="line">    </div><div class="line">    /* Determine the callback(s) to use. */</div><div class="line">  if(type &amp; CLIENTWRITE_BODY)</div><div class="line">    writebody = data-&gt;set.fwrite_func;</div><div class="line">    </div><div class="line">    if(writebody) &#123;</div><div class="line">        //调用回调函数</div><div class="line">      size_t wrote = writebody(ptr, 1, chunklen, data-&gt;set.out);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="4-cookie相关"><a href="#4-cookie相关" class="headerlink" title="4. cookie相关"></a>4. cookie相关</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div></pre></td><td class="code"><pre><div class="line">//解析指定的cookie文件</div><div class="line">//支持# Netscape HTTP Cookie File和Mozilla cookie</div><div class="line">CURLcode Curl_pretransfer(struct Curl_easy *data)//lib\transfer.c</div><div class="line">&#123;</div><div class="line"> /* If there is a list of cookie files to read, do it now! */</div><div class="line">  if(data-&gt;change.cookielist)//cookie文件列表</div><div class="line">    Curl_cookie_loadfiles(data);</div><div class="line">&#125;</div><div class="line">-&gt;</div><div class="line">void Curl_cookie_loadfiles(struct Curl_easy *data)//lib\cookie.c</div><div class="line">-&gt;</div><div class="line">//读取cookie文件，初始化cookie结构</div><div class="line">struct CookieInfo *Curl_cookie_init(struct Curl_easy *data,</div><div class="line">                                    const char *file,</div><div class="line">                                    struct CookieInfo *inc,</div><div class="line">                                    bool newsession)//lib\cookie.c</div><div class="line">-&gt;</div><div class="line">//lineptr是从cookie.txt中读取的每行数据，解析数据，插入CookieInfo链</div><div class="line">struct Cookie *</div><div class="line">Curl_cookie_add(struct Curl_easy *data,</div><div class="line">                /* The &apos;data&apos; pointer here may be NULL at times, and thus</div><div class="line">                   must only be used very carefully for things that can deal</div><div class="line">                   with data being NULL. Such as infof() and similar */</div><div class="line"></div><div class="line">                struct CookieInfo *c,</div><div class="line">                bool httpheader, /* TRUE if HTTP header-style line */</div><div class="line">                char *lineptr,   /* first character of the line */</div><div class="line">                const char *domain, /* default domain */</div><div class="line">                const char *path)   /* full path used when this cookie is set,</div><div class="line">                                       used to get default path for the cookie</div><div class="line">                                       unless set */</div><div class="line">&#123;</div><div class="line">//...</div><div class="line">clist = c-&gt;cookies;</div><div class="line">  replace_old = FALSE;</div><div class="line">  while(clist) &#123;</div><div class="line">    if(Curl_raw_equal(clist-&gt;name, co-&gt;name)) &#123;</div><div class="line">      /* the names are identical */</div><div class="line"></div><div class="line">      if(clist-&gt;domain &amp;&amp; co-&gt;domain) &#123;</div><div class="line">        if(Curl_raw_equal(clist-&gt;domain, co-&gt;domain))</div><div class="line">          /* The domains are identical */</div><div class="line">          replace_old=TRUE;</div><div class="line">      &#125;</div><div class="line">      else if(!clist-&gt;domain &amp;&amp; !co-&gt;domain)</div><div class="line">        replace_old = TRUE;</div><div class="line"></div><div class="line">      if(replace_old) &#123;</div><div class="line">        /* the domains were identical */</div><div class="line"></div><div class="line">        if(clist-&gt;spath &amp;&amp; co-&gt;spath) &#123;</div><div class="line">          if(Curl_raw_equal(clist-&gt;spath, co-&gt;spath)) &#123;</div><div class="line">            replace_old = TRUE;</div><div class="line">          &#125;</div><div class="line">          else</div><div class="line">            replace_old = FALSE;</div><div class="line">        &#125;</div><div class="line">        else if(!clist-&gt;spath &amp;&amp; !co-&gt;spath)</div><div class="line">          replace_old = TRUE;</div><div class="line">        else</div><div class="line">          replace_old = FALSE;</div><div class="line"></div><div class="line">      &#125;</div><div class="line">      //。。。</div><div class="line"></div><div class="line">      if(replace_old) &#123;</div><div class="line">        co-&gt;next = clist-&gt;next; /* get the next-pointer first */</div><div class="line"></div><div class="line">        *clist = *co;  /* then store all the new data */</div><div class="line"></div><div class="line">        free(co);   /* free the newly alloced memory */</div><div class="line">        co = clist; /* point to the previous struct instead */</div><div class="line"></div><div class="line">        /* We have replaced a cookie, now skip the rest of the list but</div><div class="line">           make sure the &apos;lastc&apos; pointer is properly set */</div><div class="line">        do &#123;</div><div class="line">          lastc = clist;</div><div class="line">          clist = clist-&gt;next;</div><div class="line">        &#125; while(clist);</div><div class="line">        break;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    lastc = clist;</div><div class="line">    clist = clist-&gt;next;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  if(c-&gt;running)</div><div class="line">    /* Only show this when NOT reading the cookies from a file */</div><div class="line">    infof(data, &quot;%s cookie %s=\&quot;%s\&quot; for domain %s, path %s, &quot;</div><div class="line">          &quot;expire %&quot; CURL_FORMAT_CURL_OFF_T &quot;\n&quot;,</div><div class="line">          replace_old?&quot;Replaced&quot;:&quot;Added&quot;, co-&gt;name, co-&gt;value,</div><div class="line">          co-&gt;domain, co-&gt;path, co-&gt;expires);</div><div class="line"></div><div class="line">  if(!replace_old) &#123;</div><div class="line">    /* then make the last item point on this new one */</div><div class="line">    if(lastc)</div><div class="line">      lastc-&gt;next = co;</div><div class="line">    else</div><div class="line">      c-&gt;cookies = co;</div><div class="line">    c-&gt;numcookies++; /* one more cookie in the jar */</div><div class="line">  &#125;</div><div class="line"> //...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="0x06-其他"><a href="#0x06-其他" class="headerlink" title="0x06. 其他"></a>0x06. 其他</h1><p>封装了一份简单的http类，支持GET、POST、ajax，代码比较简单，有需要的可以拿来用，后续可能会更新</p>
<p>源码：<a href="https://github.com/anhkgg/minihttp" target="_blank" rel="external">https://github.com/anhkgg/minihttp</a></p>
<p><a href="https://curl.haxx.se/libcurl/" target="_blank" rel="external">https://curl.haxx.se/libcurl/</a></p>
<p><a href="http://www.liyuduo.com/?p=1103" target="_blank" rel="external">https://curl.haxx.se/libcurl/3</a></p>
<p><a href="http://blog.csdn.net/breaksoftware/article/details/45874197" target="_blank" rel="external">http://blog.csdn.net/breaksoftware/article/details/45874197</a></p>
<p>转载请注明出处：<a href="http://anhkgg.github.io/liburl-use-minihttp/">http://anhkgg.github.io/liburl-use-minihttp/</a></p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/idc-base-usage-test-note/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          IDC脚本小试笔记
        
      </div>
    </a>
  
  
    <a href="/pin-use-note-function-analysis/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">pin使用小记-函数分析</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">Share to: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
    <a class="jiathis_button_twitter"></a>
    <a class="jiathis_button_plus"></a> 
    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="liburl-use-minihttp/" data-title="libcurl小记-简单http封装使用-源码分析" data-url="https://anhkgg.github.io/liburl-use-minihttp/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"anhkgg"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>



</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2017 Anhkgg
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F1356cee6585113888657f9b35b0a8295' type='text/javascript'%3E%3C/script%3E"));
</script>


  </div>
</body>
</html>